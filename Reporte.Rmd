---
output:
  pdf_document:
    extra_dependencies:
      enumitem: ["shortlabels"]
      booktabs: null
      array: null
      arydshln: null
      caption: null
    includes: 
      before_body: title_page.tex
---

\renewcommand{\tablename}{Tabla}
\renewcommand{\figurename}{Figura}
\captionsetup[figure]{skip=0pt}

```{r librerias, include=FALSE, message=FALSE}
library(tidyverse)
library(rio)
library(patchwork)
```

# 1 Introducción

El problema a resolver en el siguiente informe es poder dilucidar los problemas que presenta la Tarjeta de Compra Más. En una reunión entre las diferentes partes de la empresa, se presentaron cuatro hipótesis sobre posibles problemas en la TCM.

A continuación se presenta una pequeña vista a los datos entregados, y se explica la metodología a utilizar para estudiar las hipótesis planteadas. Luego, en la sección \textbf{Hipótesis a Cubrir}, se presentan y se estudian las cuatro hipótesis planteadas durante la reunión de la empresa.

Finalmente, en la sección \textbf{Conclusión}, se entrega un resumen de los resultados obtenidos en la sección anterior, y al mismo tiempo se proponen diferentes medidas para mejorar el uso de la TCM.

## 1.1 Datos entregados

La base de datos con la que se trabaja corresponde al registro de 450 clientes para los cuales se tienen los siguientes atributos:

- Cliente: Identificador único

- Edad:

- Sex:

- Reg:

- Uso2022:

- UsoMarzo

- MontoMarzo

- MontoAcum

```{r carga de datos, include=FALSE, message=FALSE}
datos_tcm <- rio::import('TCM2022.xlsx')
datos_tcm_tibble <- tibble::as_tibble(datos_tcm)
```

## 1.2 Metodología

# 2 Hipótesis a Cubrir

## 2.1 Bajo uso

La primera hipótesis planteada es que el porcentaje de uso de la TCM, en el primer trimestre del 2022, ha disminuido con respecto al uso en el 2021, que corresponde a un 62%.

```{r H1 - uso tarjeta, echo=FALSE}
n <- nrow(datos_tcm)
uso_tarjeta_2021 <- 0.62
uso_tarjeta_2022 <- mean(datos_tcm$Uso2022)

porcentaje_2022 <- paste0(as.character(100*round(uso_tarjeta_2022, 2)), '%')
```

A partir de los datos vemos que el porcentaje de uso en el año 2022 corresponde a `r porcentaje_2022`. Podemos ver una comparación entre ambas cantidades en la Figura 1.

```{r H1 - comparacion prop, echo=FALSE}
ggplot(tibble(uso = c(uso_tarjeta_2021, uso_tarjeta_2022),
              año = c('2021', '2022'))) +
  geom_col(mapping = aes(x = año, y = uso), fill = c('salmon', 'turquoise')) +
  geom_text(mapping = aes(x = año, y = uso, label = scales::percent(uso)),
            position = position_dodge(width = .9),
            vjust = -0.5, size = 7) +
  labs(title = 'Uso de tarjeta TCM años 2021 y 2022') +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1))
```

Se puede observar en el gráfico que efectivamente el uso de la tarjeta parece ser menor para el primer trimestre de 2022 en comparación con el mismo periodo en el año 2021.

Ahora, proponemos un test binomial exacto para confirmar si hallazgos son significativos. Este test es adecuado pues permite establecer si una muestra de datos binarios proviene de una población con proporción menor a un valor dado.

```{r H1 - test binomial exacto, include=FALSE}
binom.test(x = sum(datos_tcm$Uso2022),
           n = n,
           p = uso_tarjeta_2021,
           alternative = 'less')
```

Si relajamos algunas exigencias, en particular el nivel de significancia a un $10\%$, concluimos que hay evidencia en favor de que la disminución en el uso de la tarjeta es estadísticamente significativa.

## 2.2 Montos

En esta sección se estudia la hipótesis de que el monto promedio utilizado en el mes de Marzo  de 2022 es mayor al monto promedio utilizado en el mismo mes del año 2021.


Para esto, primero calculamos este promedio para cada mes. Notamos que existe una cantidad importante de clientes con monto 0. Esto se debe a que hay clientes que no utilizan su tarjeta durante Marzo 2022. Para este análisis, solo se considera el monto tranzado por clientes que sí registran uso en su tarjeta para este mes.

```{r H2 - clientes que compran, echo=FALSE}
datos_tcm_compras <- datos_tcm_tibble %>% 
  dplyr::filter(UsoMarzo == 1)
```

```{r H2 - promedio compras 2022}
monto_promedio_marzo_2021 <- 400

monto_promedio_marzo_2022 <- datos_tcm_compras %>% 
  dplyr::summarise(media = mean(MontoMarzo)) %>% 
  as.numeric()
```

Obtenemos que el monto promedio en marzo del 2022 es `r round(monto_promedio_marzo_2022, 2)`. Ahora se verificará que la diferencia encontrada es estadísticamente significativa.

Una alternativa es utilizar un _test-t_, sin embargo para que los resultados sean válidos se debe asegurar que los datos provienen de una distribución Normal.

En las siguientes figuras se estudia el supuesto de normalidad de manera gráfica mediante estimación de kernel y gráfico QQ.

```{r H2 - supuesto normalidad - densidad, echo=FALSE}
# Aca podríamos ver cómo combinar dos plots, creo que el paquete patchwork es bueno
dens1 = ggplot(datos_tcm_compras) +
  geom_density(mapping = aes(x = MontoMarzo), fill = 'salmon') +
  labs(x = 'Monto', y = 'densidad',
       title = 'Densidad estimada',
       subtitle = "Montos compras, marzo 2022")
```

```{r H2 - supuesto normalidad - qqplot, echo=FALSE, fig.cap="Test gráficos para normalidad media montos compra"}
qq1 = ggplot(datos_tcm_compras) +
  geom_qq_line(aes(sample = MontoMarzo), color = "salmon", lwd = 2) +
  geom_qq(aes(sample = MontoMarzo)) +
  labs(title = 'QQ-Norm montos compra', subtitle = 'Marzo 2022',
       x = 'Cuantiles teóricos', y = 'Cuantiles muestrales')

# grafico final

dens1 + qq1

```

Ahora se complementa el análisis gráfico con un test específico para normalidad: Shapiro-Wilk

```{r H2 - test ShapiroWilk, include=FALSE}
test_norm = shapiro.test(datos_tcm_compras$MontoMarzo)
```

Para el test de Shapiro-Wilk se tiene un Valor-P de `r test_norm$p.value %>% round(digits = 4)`. En consecuencia, no podemos asumir normalidad, por lo que ocupamos un test no paramétrico (Wilcoxon) para establecer la significancia en la diferencia entre el promedio de los montos tranzados en Marzo de 2022 y 2021.

```{r H2 - test de Wilcoxon, include = FALSE}
test_diff = wilcox.test(x = datos_tcm_compras$MontoMarzo,
            mu = monto_promedio_marzo_2021,
            alternative = 'greater')
```

Para el test de Wilcoxon se tiene un Valor-P de `r test_diff$p.value %>% round(digits = 4)`. En consecuencia, encontramos que hay evidencia en favor de que la diferencia es significativa.

```{r H2 - test t, include = FALSE}
test_diff_t = t.test(x = datos_tcm_compras$MontoMarzo,
       mu = monto_promedio_marzo_2021,
       alternative = 'greater')
```

Ahora, en favor de la comparación, aplicamos un test t. Si asumimos que el tamaño de muestra es lo suficientemente grande, la aplicación de este test se valida con resultados asintóticos. Se observan resultados consecuentes en ambos test, pues para para el _test-t_ el valor -P  es `r test_diff_t$p.value %>% round(digits = 4)`


Vemos que en ambos casos rechazamos la hipótesis que el monto del 2022 es menor al del 2021, por lo que aceptamos que fue superior al del 2021...

## 2.3 Antiguos

En esta sección se estudia la hipótesis de que la diferencia en los montos medios tranzados por clientes antiguos y nuevos es de cien mil. Para eso, segmentamos en clientes antiguos y nuevos. De manera similar como en la sección _2.2_, no consideramos clientes que no registran uso de su tarjeta en el periodo examinado.

```{r H3 - separacion clientes, echo=FALSE}
clientes_antiguos <- datos_tcm_tibble %>% 
  dplyr::filter(Cliente < 250000) %>% 
  dplyr::filter(Uso2022 == 1)

clientes_nuevos <- datos_tcm_tibble %>% 
  dplyr::filter(Cliente >= 250000) %>% 
  dplyr::filter(Uso2022 == 1)

n_antiguos <- nrow(clientes_antiguos)
n_nuevos <- nrow(clientes_nuevos)

media_antiguos <- mean(clientes_antiguos$MontoAcum)
media_nuevos <- mean(clientes_nuevos$MontoAcum)
```

Tenemos que hay `r n_antiguos` clientes antiguos y `r n_nuevos` clientes nuevos presentes en la base de datos entregada. Además, los montos medios de cada grupo son `r  media_antiguos %>% round(digits = 4)` y `r media_nuevos %>% round(digits = 4)`, respectivamente.

Queremos ocupar un test t para dos muestras, así que vemos normalidad...

Ahora se estudia si los datos siguen una distribución Normal mediante métodos gráficos: primero por estimación kernel y luego mediante QQ-plot.

```{r H3 - supuesto normalidad, echo = FALSE, fig.cap="Test gráficos de normalidad media montos compra por segmento"}
# Acá usemos patchwork para juntar los gráficos

## Densidad antiguos
dens2_antiguos = ggplot(clientes_antiguos) +
  geom_density(mapping = aes(x = MontoAcum), fill = 'salmon') +
  labs(x = 'Monto', y = 'densidad',
       title = 'Densidad montos compra',
       subtitle = 'Marzo 2022, clientes antiguos')

## QQ-plot antiguos
qq2_antiguos = ggplot(clientes_antiguos) +
  geom_qq_line(aes(sample = MontoAcum), color = "salmon", lwd = 2) +
  geom_qq(aes(sample = MontoAcum)) +
  labs(title = 'QQ-Plot montos compra', subtitle = 'Marzo 2022, clientes antiguos',
       x = 'Cuantiles teóricos', y = 'Cuantiles muestrales')

## Densidad nuevos
dens2_nvos = ggplot(clientes_nuevos) +
  geom_density(mapping = aes(x = MontoAcum), fill = 'salmon') +
  labs(x = 'Monto', y = 'densidad',
       title = 'Densidad montos compra',
       subtitle = 'Marzo 2022, clientes nuevos')

## QQ-plot antiguos
qq2_nvos = ggplot(clientes_nuevos) +
  geom_qq_line(aes(sample = MontoAcum), color = "salmon", lwd = 2) +
  geom_qq(aes(sample = MontoAcum)) +
  labs(title = 'QQ-Plot montos compra', subtitle = 'Marzo 2022, clientes nuevos',
       x = 'Cuantiles teóricos', y = 'Cuantiles muestrales')

(dens2_antiguos + qq2_antiguos) / (dens2_nvos + qq2_nvos)
```

De manera similar como en la seccion _2.2_, se confirman los hallazgos con test formales: usamos Shapiro-Wilk. En los clientes nuevos además utilizamos el test de Kolmogorov-Smirnov al obtener un valor-p bastante cercano a 0.05...

```{r H3 - supuesto normalidad formal, include=FALSE}
shapiro.test(clientes_antiguos$MontoAcum)

shapiro.test(clientes_nuevos$MontoAcum)
ks.test(scale(clientes_nuevos$MontoAcum), y = 'pnorm')
```

No se encuentra evidencia para rechazar normalaidad. En consecuencia se aplica un _test-t_ para estdudiar la diferencia de medias.

Primero tenemos que ver si usamos varianzas iguales y desconocidas o diferentes y desconocidas.

```{r H3 - Test varianzas, include=FALSE}
test_var = var.test(x = clientes_antiguos$MontoAcum,
         y = clientes_nuevos$MontoAcum,
         alternative = 'two.sided')

```

Se rechaza el test con un valor-P `r  test_var$p.value %>% round(digits = 4)`, por lo que trabajamos varianzas diferentes. Se asume que las varianzas son desconocidas.

```{r H3 - Test t final, include=FALSE}
t.test(x = clientes_nuevos$MontoAcum,
       y = clientes_antiguos$MontoAcum,
       mu = 100,
       alternative = 'greater',
       var.equal = FALSE)
```

Vemos entonces que no podemos rechazar la hipótesis nula...

## 2.4 Atributos

Agrupamos los datos de edades en los grupos correspondientes...

```{r H3 - agrupacion edades, echo=FALSE}
datos_tcm_tibble_edadcat <- datos_tcm_tibble %>% 
  dplyr::mutate(edad_cat = case_when(
    Edad <= 35 ~ 0,
    between(Edad, 36, 54) ~ 1,
    Edad >= 55 ~ 2
  ))
```

Acá rellenamos con gráficos si no nos pasamos de las 5 páginas...

Acá van los ANOVAS...

Concluimos

# 3 Conclusión
